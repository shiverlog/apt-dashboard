<!DOCTYPE html>
<html lang="utf-8">
    {% include 'fragment/header.html' %}
    <body class="sb-nav-fixed">
        {% include 'fragment/nav.html' %}
        <div id="layoutSidenav">
            <div id="layoutSidenav_content">
            {% include 'fragment/sidebar.html' %}
            <div class="container-lg">
            <h1>Line Charts</h1>
                <!-- 카테고리 선택 폼 -->
                <div class="col-xl-12">
                    <div class="card mb-4">
                        <form method="POST" action="/line_charts_detail" id="categoryForm">
                            <div class="card-header">
                                <i class="fas fa-chart-area me-1"></i>
                                카테고리 별 월별 매출 Line Charts로 시각화
                            </div>
                            <div class="card-body text-end">
                                <div class="d-inline-flex align-items-center">
                                   <label for="category" class="form-label me-2">Select a category:</label>
                                   <select id="category" name="category" class="form-select w-50" onchange="document.getElementById('categoryForm').submit();">
                                      <option value="all" {% if selected_category == 'all' %}selected{% endif %}>All Categories</option>
                                      <option value="outlook" {% if selected_category == 'outlook' %}selected{% endif %}>Total view</option>
                                      {% for category in categories %}
                                      <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>{{ category }}</option>
                                      {% endfor %}
                                   </select>
                                </div>
                                {% if chart_data %}
                                <div class="card-body">
                                    <canvas id="myAllLineCharts" width="100%" height="30"></canvas>
                                </div>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% include 'fragment/footer.html' %}
            </div>
        </div>

        {% if chart_data %}
        <script>
            var ctxArea = document.getElementById("myAllLineCharts").getContext("2d");

            {% if selected_category == 'outlook' %}
            // 전체 카테고리 데이터를 시각화하는 경우
            var chartData = {
                labels: {{ chart_data['Beverages']['labels'] | tojson }},  // 모든 카테고리가 공유하는 x축(월별)
                datasets: [
                    {% for category, data in chart_data.items() %}
                    {
                        label: "{{ category }}",
                        data: {{ data['values'] | tojson }},
                        fill: false,
                        borderColor: getRandomColor(),
                        tension: 0.1
                    },
                    {% endfor %}
                ]
            };
            {% else %}
            // 개별 카테고리 데이터를 시각화하는 경우
            var randomBackgroundColor = getRandomColor();
            var randomBorderColor = getRandomColor();

            var chartData = {
                labels: {{ chart_data['labels'] | tojson }},
                datasets: [{
                    label: "{{ selected_category }}" === 'all' ? "Total Sales" : `Total Sales for {{ selected_category }}`,
                    data: {{ chart_data['values'] | tojson }},
                    fill: false,
                    backgroundColor: randomBackgroundColor,
                    borderColor: randomBorderColor
                }]
            };
            {% endif %}

            // 랜덤 색상 생성 함수
            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            // 차트 그리기
            new Chart(ctxArea, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Arial'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        </script>
        {% endif %}
    </body>
</html>