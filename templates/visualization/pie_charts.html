<!DOCTYPE html>
<html lang="en">
    {% include 'fragment/header.html' %}
    <body class="sb-nav-fixed">
        {% include 'fragment/nav.html' %}
        <div id="layoutSidenav">
            <div id="layoutSidenav_content">
                {% include 'fragment/sidebar.html' %}
                <div class="container-lg">
                    <h1>Pie Charts</h1>

                    <!-- 카테고리별 총 매출 원형 차트 -->
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-chart-pie"></i>
                                카테고리별 총 매출
                            </div>
                            <div class="card-body">
                                <canvas id="categorySalesPieChart" width="400" height="400"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 월별 매출액 카테고리 차트 -->
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-chart-pie"></i>
                                월별 매출액 카테고리 차트
                            </div>
                            <div class="card-body">
                                {% for month, data in sales_data.items() %}
                                <div style="display:inline-block; width:150px; margin:20px;">
                                    <canvas id="chart-{{ month }}" width="200" height="150"></canvas>
                                    <p>{{ month }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% include 'fragment/footer.html' %}
            </div>
        </div>
        <!-- Chart.js를 이용한 원형 차트 렌더링 -->
        <script>
            document.addEventListener("DOMContentLoaded", function() {
    // 카테고리별 색상을 고정
    var categoryColors = {
        "Beverages": 'rgba(255, 69, 58, 0.8)',
        "Confections": 'rgba(255, 99, 132, 0.8)',
        "Condiments": 'rgba(255, 206, 86, 0.8)',
        "Seafood": 'rgba(75, 192, 192, 0.8)',
        "Dairy Products": 'rgba(102, 102, 255, 0.8)',
        "Grains/Cereals": 'rgba(255, 159, 64, 0.8)',
        "Meat/Poultry": 'rgba(255, 99, 71, 0.8)',
        "Produce": 'rgba(34, 139, 34, 0.8)'
    };

    // 서버에서 전달된 카테고리별 총 매출 데이터를 사용 (숫자로 변환)
    var categorySalesData = {{ category_sales_data | tojson | safe }};
    var categoryLabels = categorySalesData.map(item => item.CategoryName);
    var salesValues = categorySalesData.map(item => parseFloat(item.TotalSales));  // 문자열을 숫자로 변환

    var totalSales = salesValues.reduce((a, b) => a + b, 0);

    // 카테고리별 총 매출 차트
    var ctxPie = document.getElementById("categorySalesPieChart").getContext("2d");
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                label: 'Category Sales',
                data: salesValues,  // 숫자로 변환된 매출 데이터
                backgroundColor: categoryLabels.map(label => categoryColors[label]), // 고정된 색상 사용
                borderColor: categoryLabels.map(label => categoryColors[label].replace('0.8', '1')), // 경계선 색상
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            var value = tooltipItem.raw;
                            var percentage = ((value / totalSales) * 100).toFixed(2);
                            return tooltipItem.label + ': ' + value + ' USD (' + percentage + '%)';
                        }
                    }
                },
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            family: 'Arial'
                        }
                    }
                }
            }
        }
    });

    // 월별 매출 차트 생성
    var salesData = {{ sales_data | tojson | safe }};
    Object.keys(salesData).forEach(function(month) {
        var ctx = document.getElementById("chart-" + month);
        if (ctx) {
            var chartData = salesData[month].map(item => item.category_sales);
            var monthTotalSales = chartData.reduce((a, b) => a + b, 0);

            new Chart(ctx.getContext("2d"), {
                type: 'pie',
                data: {
                    labels: salesData[month].map(item => item.category),
                    datasets: [{
                        data: chartData,
                        backgroundColor: salesData[month].map(item => categoryColors[item.category]), // 고정된 색상 사용
                        borderColor: salesData[month].map(item => categoryColors[item.category].replace('0.8', '1')), // 경계선 색상
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    var value = tooltipItem.raw;
                                    var percentage = ((value / monthTotalSales) * 100).toFixed(2);
                                    return tooltipItem.label + ': ' + value + ' USD (' + percentage + '%)';
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    });
});

        </script>
    </body>
</html>
